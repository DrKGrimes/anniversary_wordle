<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anniversary Wordle</title>
  <style>
    /* existing styles unchanged */
  </style>
</head>
<body>
  <div id="toast"></div>
  <header>
    <div>
      <h1>Anniversary Wordle</h1>
      <div class="subtitle">Love, luck, and the Year of the Pig üêñ</div>
    </div>
    <div class="bar">
      <button id="newGameBtn">New game</button>
      <button id="shareBtn">Share</button>
    </div>
  </header>
  <main>
    <div class="bar">
      <div id="status" class="muted">Guess the word in 6 tries.</div>
      <div><label><input type="checkbox" id="showHint"> Show hint</label></div>
    </div>
    <div id="hint" class="hint" style="display:none"></div>
    <div id="board"></div>
    <div id="keyboard"></div>
  </main>
  <footer></footer>
<script>
/**************
 * THEMED WORD LIST (5 letters each)
 * Add or remove entries as you like. Each has a hint.
 **************/
const THEME_WORDS = [
  { word: 'paper', hint: '1st anniversary traditional gift' },
  { word: 'linen', hint: '4th anniversary (UK); textiles theme' },
  { word: 'ivory', hint: '14th anniversary (traditional)' },
  { word: 'china', hint: '20th anniversary gift' },
  { word: 'pearl', hint: '30th anniversary' },
  { word: 'coral', hint: '35th anniversary' },
  { word: 'bacon', hint: 'Pig theme (Year of the Pig)' },
  { word: 'swine', hint: 'Pig theme' },
  { word: 'boars', hint: 'Pig theme (plural of boar)' },
  { word: 'oinks', hint: 'Pig sounds' },
  { word: 'earth', hint: 'Earth Pig (elemental sign)' },
  { word: 'roses', hint: 'Classic anniversary flowers' },
  { word: 'toast', hint: 'Raise a toast to the couple!' },
  { word: 'rings', hint: 'Wedding rings' },
  { word: 'music', hint: 'First-dance vibes' },
  { word: 'cards', hint: 'Anniversary cards' },
  { word: 'happy', hint: 'Happy anniversary!' }
].filter(x => !x.disabled && x.word.length === 5);

/**************
 * DICTIONARY ‚Äî loaded dynamically from words.txt
 **************/
let ALLOWED_EXTRA_GUESSES = new Set();
let DICTIONARY_READY = false;

async function loadWordList() {
  try {
    const resp = await fetch('words.txt', { cache: 'no-store' });
    if (!resp.ok) throw new Error(`Failed to load words.txt: ${resp.status}`);
    const text = await resp.text();
    const words = text
      .split(/\r?\n/) // handles both Windows and Unix newlines
      .map(w => w.trim().toLowerCase())
      .filter(w => w.length === 5 && /^[a-z]+$/.test(w));
    ALLOWED_EXTRA_GUESSES = new Set(words);
    DICTIONARY_READY = true;
    console.log(`Loaded ${ALLOWED_EXTRA_GUESSES.size} words from words.txt`);
  } catch (err) {
    console.error('Error loading dictionary:', err);
    toast('Could not load words.txt ‚Äî using themed words only.');
  }
}





/**************
 * UTILITIES
 **************/
const $ = s => document.querySelector(s);
const params = new URLSearchParams(location.search);

function seededIndex(seedStr, listLen){
  // Simple xorshift32 from string -> 32-bit -> index
  let h = 2166136261 >>> 0;
  for (let i=0;i<seedStr.length;i++) { h ^= seedStr.charCodeAt(i); h = Math.imul(h, 16777619) >>> 0; }
  h ^= h << 13; h ^= h >>> 17; h ^= h << 5; h >>>= 0;
  return listLen ? (h % listLen) : 0;
}

function todaySeed(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}${m}${day}`;
}

/**************
 * GAME STATE
 **************/
let solutionObj = null; // {word, hint}
let solution = '';
let rowCount = 6;
let colCount = 5; // default to 5-letter words
let currentRow = 0;
let currentCol = 0;
let grid = [];
let finished = false;

function pickSolution(){
  const forced = params.get('answer');
  const seed = params.get('seed') || todaySeed();
  if (forced){
    const found = THEME_WORDS.find(w => w.word.toLowerCase() === forced.toLowerCase());
    solutionObj = found || { word: forced.toLowerCase(), hint: 'Custom answer via URL' };
  } else {
    const idx = seededIndex(seed, THEME_WORDS.length);
    solutionObj = THEME_WORDS[idx];
  }
  solution = solutionObj.word.toLowerCase();
  colCount = solution.length;
}

function buildBoard(){
  const board = $('#board');
  board.innerHTML = '';
  board.style.gridTemplateRows = `repeat(${rowCount}, 1fr)`;
  board.style.gridTemplateColumns = `1fr`;
  grid = [];
  for (let r=0;r<rowCount;r++){
     const row = document.createElement('div');
     row.className = 'row';
     row.style.gridTemplateColumns = `repeat(${colCount}, 56px)`;
     for (let c=0;c<colCount;c++){
       const tile = document.createElement('div');
       tile.className = 'tile';
       tile.dataset.row = r; tile.dataset.col = c;
       row.appendChild(tile);
     }
     board.appendChild(row);
     grid.push(new Array(colCount).fill(''));
  }
  currentRow = 0; currentCol = 0; finished = false;
  $('#hint').textContent = `Hint: ${solutionObj.hint} (${solution.length} letters)`;
}

function buildKeyboard(){
  const rows = [ 'QWERTYUIOP', 'ASDFGHJKL', 'ZXCVBNM' ];
  const kb = $('#keyboard');
  kb.innerHTML = '';
  rows.forEach((r,i)=>{
    const div = document.createElement('div');
    div.className = 'kb-row';
    if (i===2){ addKey(div,'Enter','big'); }
    for (const ch of r){ addKey(div,ch); }
    if (i===2){ addKey(div,'‚å´','big', 'Backspace'); }
    kb.appendChild(div);
  });
}

function addKey(rowEl, label, cls='', code){
  const k = document.createElement('div');
  k.className = 'key' + (cls? ' ' + cls : '');
  k.textContent = label;
  k.dataset.code = code || label;
  k.addEventListener('click', ()=> handleKey(k.dataset.code));
  rowEl.appendChild(k);
}

function toast(msg, ms=1200){
  const t = $('#toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(t._timer);
  t._timer = setTimeout(()=> t.style.display = 'none', ms);
}

function handleKey(code){
  if (finished) return;
  if (/^[A-Z]$/.test(code)) {
    if (currentCol < colCount) {
      const ch = code.toLowerCase();
      grid[currentRow][currentCol] = ch;
      drawCell(currentRow, currentCol, ch);
      currentCol++;
    }
  } else if (code === 'Backspace' || code === '‚å´') {
    if (currentCol > 0) {
      currentCol--;
      grid[currentRow][currentCol] = '';
      drawCell(currentRow, currentCol, '');
    }
  } else if (code === 'Enter') {
    if (currentCol !== colCount){ toast('Not enough letters'); return; }
    const guess = grid[currentRow].join('');
    if (!isValidGuess(guess)) { toast('Not in word list'); return; }
    const result = scoreGuess(guess, solution);
    revealRow(currentRow, result);
    if (guess === solution){
      finished = true;
      $('#status').textContent = `üéâ Correct! The word was ${solution.toUpperCase()}.`;
      toast('You got it!');
      return;
    }
    currentRow++;
    currentCol = 0;
    if (currentRow === rowCount){
      finished = true;
      $('#status').textContent = `üíî Out of tries. The word was ${solution.toUpperCase()}.`;
      toast('Next time!');
    }
  }
}

function drawCell(r,c,ch){
  const tile = document.querySelector(`.tile[data-row="${r}"][data-col="${c}"]`);
  tile.textContent = ch.toUpperCase();
  tile.classList.toggle('filled', !!ch);
}

function isValidGuess(g){
  if (g.length !== colCount) return false;
  // Accept solution words, themed words, or any word in words.txt
  return g === solution || THEME_WORDS.some(w => w.word === g) || ALLOWED_EXTRA_GUESSES.has(g);
}

function scoreGuess(guess, answer){
  const res = new Array(colCount).fill('absent');
  const aCounts = {};
  for (let i=0;i<colCount;i++){
    const ch = answer[i];
    aCounts[ch] = (aCounts[ch]||0)+1;
  }
  // First pass: correct
  for (let i=0;i<colCount;i++){
    if (guess[i] === answer[i]){ res[i] = 'correct'; aCounts[guess[i]]--; }
  }
  // Second: present
  for (let i=0;i<colCount;i++){
    if (res[i] === 'correct') continue;
    const ch = guess[i];
    if (aCounts[ch] > 0){ res[i] = 'present'; aCounts[ch]--; }
  }
  return res;
}

function revealRow(r, result){
  for (let c=0;c<colCount;c++){
    const tile = document.querySelector(`.tile[data-row="${r}"][data-col="${c}"]`);
    tile.classList.add('reveal', result[c]);
  }
  // Update keyboard keys
  const guess = grid[r].join('').toUpperCase();
  for (let i=0;i<colCount;i++){
    const k = document.querySelector(`.key[data-code="${guess[i]}"]`);
    if (!k) continue;
    const newCls = result[i];
    if (newCls === 'correct' || (newCls === 'present' && !k.classList.contains('correct')) || (!k.classList.contains('correct') && !k.classList.contains('present'))){
      k.classList.remove('correct','present','absent');
      k.classList.add(newCls);
    }
  }
}

function setupEvents(){
  document.addEventListener('keydown', (e)=>{
    const code = e.key.length === 1 ? e.key.toUpperCase() : e.key; // letters, Enter, Backspace
    if (/^[A-Za-z]$/.test(code) || code === 'Enter' || code === 'Backspace'){
      e.preventDefault();
      handleKey(code);
    }
  });
  $('#showHint').addEventListener('change', (e)=>{
    $('#hint').style.display = e.target.checked ? '' : 'none';
  });
  $('#newGameBtn').addEventListener('click', ()=>{
    const seed = params.get('seed') || todaySeed();
    const nextSeed = String(BigInt(seed) + 1n);
    params.set('seed', nextSeed);
    history.replaceState(null,'',`?${params.toString()}`);
    startGame();
  });
  $('#shareBtn').addEventListener('click', ()=>{
    const gridEmojis = renderShare();
    const title = `Anniversary Wordle ${solution.toUpperCase()}`;
    const text = `${title}
${gridEmojis}`;
    navigator.clipboard.writeText(text).then(()=> toast('Copied results to clipboard!'));
  });
}

function renderShare(){
  const lines = [];
  let stopAt = finished && $('#status').textContent.includes('Correct!') ? currentRow+1 : Math.min(currentRow, rowCount);
  for (let r=0;r<stopAt;r++){
    const guess = grid[r].join('');
    const result = scoreGuess(guess, solution);
    lines.push(result.map(s=> s==='correct'?'üü©': s==='present'?'üü®':'‚¨õ').join(''));
  }
  return lines.join('
');
}

async function startGame(){
  pickSolution();
  buildBoard();
  buildKeyboard();
  $('#status').textContent = DICTIONARY_READY
    ? `Guess the word in ${rowCount} tries.`
    : `Dictionary not loaded ‚Äî themed words only. Guess the word in ${rowCount} tries.`;
  $('#hint').style.display = $('#showHint').checked ? '' : 'none';
}

// Boot: set up UI, then load dictionary, then start game
setupEvents();
loadWordList().finally(() => {
  startGame();
});
</script>
</body>
</html>
